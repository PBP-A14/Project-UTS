{% extends "base.html" %}

{% block content %}
<style>
  h1 {
    font-size: 36px;
    color: #333;
    align-items: center;
    justify-content: center;
    text-align: center;
    margin-top: 80px;
    margin-bottom: 20px;
  }

  h2 {
    font-size: 20px;
    color: #000000;
    margin-left: 15px;
    margin-top: 15px
  }

  ul {
    list-style: none;
  }

  li {
    margin: 5px 0;
    margin-left: 0px;
    font-size: 16px;
    color: #555;
  }

  a.btn-target {
    background-color: #0077cc;
    color: #fff;
    padding: 7px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 15px;
    text-decoration: none;
  }

  p {
    margin-left: 15px;
  }

  .btn.btn-primary {
    background-color: #0077cc;
    color: #fff;
    padding: 7px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 0px;
    margin-top: 10px;
  }

</style>

  <h1>Progress Literasi Anda</h1>
  <ul>
    {% for progress in progress_user %}
      <li>{{ progress.buku.judul }} - {% if progress.buku_selesai %}Selesai{% else %}Belum Selesai{% endif %}</li>
    {% endfor %}
  </ul>

  <h2>Target Baca Harian Anda</h2>
  <ul>
    {% if target_buku %}
      <li>Anda ingin membaca {{ target_buku }} buku hari ini.</li>
    {% else %}
      <li>Anda belum menetapkan target harian.</li>
    {% endif %}
  </ul>
  <a class ="btn-target" href="{% url 'progress_literasi:set_target' %}">Set Target Harian</a>

  <h2>Waktu Aktif Pengguna</h1>
  <p class="d-inline-flex gap-1">
    <a class="btn btn-primary" data-bs-toggle="collapse" href="#activity-status" role="button" aria-expanded="false" aria-controls="activity-status">Tampilkan Statistik</a>
    <a class="btn btn-primary" data-bs-toggle="collapse" href="#activity-history" role="button" aria-expanded="false" aria-controls="activity-history">Tampilkan Riwayat Aktivitas</a>
  </p>

  <div class="collapse" id="activity-status">
    <h2>Statistik Waktu Aktif</h2>
    <p>Anda dapat menampilkan grafik atau statistik waktu aktif pengguna di sini.</p>
    <div id="activity-chart">
      <canvas id="activityChart" width="100" height="100"></canvas>
    </div>
  </div>

  <div class="collapse" id="activity-history">
    <h2>Riwayat Aktivitas Pengguna</h2>
    <ul>
      <li>
        <strong>Tanggal:</strong>
        <span id="realtime-date"></span> 
        <strong>Waktu Aktif: {{ elapsed_time }}</strong>
        <span id="realtime-activity"></span> 
      </li>
    </ul>
  </div>

  <h2>History Buku Anda</h2>
  <ul>
    {% for buku in buku_dibaca %}
      <li>{{ buku.buku.judul }} - {{ buku.tanggal_dibaca }}</li>
    {% endfor %}
  </ul>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var dateElement = document.getElementById("realtime-date")
    var activityElement = document.getElementById("realtime-activity");
    var loginTimestamp = localStorage.getItem("loginTimestamp");

    // Fungsi untuk mengupdate waktu aktif sebagai timer
    function updateActivityTimer() {
      var now = new Date();
      var dateString = now.toLocaleDateString();
      var currentTime = Date.now();
      var elapsedTime = Math.floor((currentTime - loginTimestamp) / 1000); // Calculate elapsed time in seconds

      if (!loginTimestamp) {
        // Jika loginTimestamp belum ada, inisialisasi dengan waktu saat ini
        loginTimestamp = currentTime;
        localStorage.setItem("loginTimestamp", loginTimestamp);
      }

      // Cek apakah selisih waktu lebih dari satu hari (86400 detik)
      if (elapsedTime > 86400) {
        // Jika lebih dari satu hari, inisialisasi waktu dari awal
        loginTimestamp = currentTime;
        localStorage.setItem("loginTimestamp", loginTimestamp);
        elapsedTime = 0;
      }

      // Konversi waktu ke format jam:menit:detik
      var hours = Math.floor(elapsedTime / 3600);
      var minutes = Math.floor((elapsedTime % 3600) / 60);
      var seconds = elapsedTime % 60;

      // Format waktu
      var timeString = hours.toString().padStart(2, '0') + ':' +
                      minutes.toString().padStart(2, '0') + ':' +
                      seconds.toString().padStart(2, '0');
      activityElement.textContent = timeString;
      dateElement.textContent = dateString;
    }

    var timerIntervalId = setInterval(updateActivityTimer, 1000);

    function handleLogout() {
      clearInterval(timerIntervalId);

    }

    var logoutButton = document.getElementById("btn-logout");
      if (logoutButton) {
        logoutButton.addEventListener("click", function() {
          console.log("logout bang")
          handleLogout();
        });
      }

    updateActivityTimer();

  });

  </script>
  
  <script>
    // Get the canvas element for the chart
    const ctx = document.getElementById('activityChart').getContext('2d');

    const initialData = [6, 1, 1, 1, 1, 1, 1];
  
    // Create a line chart
    const activityChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Hari 1', 'Hari 2', 'Hari 3', 'Hari 4', 'Hari 5', 'Hari 6', 'Hari 7'],
        datasets: [{
          label: 'Waktu Aktif Harian',
          data: [], // Initialize with empty data
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1,
        }],
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: 24,
          },
        },
      },
    });
  
    // Function to update the chart with new data
    function updateChart(newValue) {
      // Push the new value to the dataset
      activityChart.data.datasets[0].data.push(newValue);
  
      // Remove the oldest data point if there are more than 7 data points
      if (activityChart.data.datasets[0].data.length > 7) {
        activityChart.data.datasets[0].data.shift();
      }
  
      // Update the chart
      activityChart.update();
    }
  
    // Example: Updating the chart with timer value every 5 seconds
    setInterval(function() {
      const timerValue = activityElement.textContent; // Get the timer value
      const [hours, minutes, seconds] = timerValue.split(':');
      const totalHours = parseInt(hours) + parseInt(minutes) / 60 + parseInt(seconds) / 3600;
      updateChart(totalHours);
    }, 5000); // Update the chart every 5 seconds
  
  </script>
  
{% endblock content %}